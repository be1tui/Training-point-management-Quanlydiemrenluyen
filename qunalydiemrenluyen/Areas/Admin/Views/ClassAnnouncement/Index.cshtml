@model QUANLYDIEMRENLUYEN.Areas.Admin.Models.MeetingNotification
@{
    ViewData["Title"] = "Thông báo họp lớp";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
    var announcements = ViewBag.Announcements as List<QUANLYDIEMRENLUYEN.Areas.Admin.Models.MeetingNotification>;
}

<div class="row">
    <div class="col-12">
        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0 font-size-18">@ViewData["Title"]</h4>
            <div class="page-title-right">
                <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home", new { Area = "Admin" })">Trang chủ</a></li>
                    <li class="breadcrumb-item active">@ViewData["Title"]</li>
                </ol>
            </div>
        </div>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["EmailWarningMessage"] != null)
{
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        @TempData["EmailWarningMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">Tạo thông báo họp lớp mới</h5>
    </div>
    <div class="card-body">
        <form asp-action="Create" method="post">
            @Html.AntiForgeryToken()
            <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label asp-for="FacultyId" class="form-label">Khoa/Viện</label>
                    <select asp-for="FacultyId" class="form-select" asp-items="ViewBag.Faculties" id="facultySelect">
                        <option value="">-- Chọn Khoa/Viện --</option>
                    </select>
                    <span asp-validation-for="FacultyId" class="text-danger"></span>
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="ClassId" class="form-label">Lớp</label>
                    <select asp-for="ClassId" class="form-select" asp-items="ViewBag.Classes" id="classSelect">
                        <option value="">-- Chọn Lớp --</option>
                    </select>
                    <span asp-validation-for="ClassId" class="text-danger"></span>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label asp-for="AcademicYearId" class="form-label">Năm học</label>
                    <select asp-for="AcademicYearId" class="form-select" asp-items="ViewBag.AcademicYears" id="academicYearSelect">
                        <option value="">-- Chọn Năm học --</option>
                    </select>
                    <span asp-validation-for="AcademicYearId" class="text-danger"></span>
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="SemesterId" class="form-label">Học kỳ</label>
                    <select asp-for="SemesterId" class="form-select" asp-items="ViewBag.Semesters" id="semesterSelect">
                        <option value="">-- Chọn Học kỳ --</option>
                    </select>
                    <span asp-validation-for="SemesterId" class="text-danger"></span>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label asp-for="MeetingDate" class="form-label">Ngày họp</label>
                    <input asp-for="MeetingDate" type="date" class="form-control" value="@Model.MeetingDate.ToString("yyyy-MM-dd")" />
                    <span asp-validation-for="MeetingDate" class="text-danger"></span>
                </div>
                <div class="col-md-4 mb-3">
                    <label asp-for="MeetingTime" class="form-label">Thời gian họp</label>
                    <input asp-for="MeetingTime" type="time" class="form-control" />
                    <span asp-validation-for="MeetingTime" class="text-danger"></span>
                </div>
                <div class="col-md-4 mb-3">
                    <label asp-for="Location" class="form-label">Địa điểm họp</label>
                    <input asp-for="Location" class="form-control" />
                    <span asp-validation-for="Location" class="text-danger"></span>
                </div>
            </div>

            <div class="mb-3">
                <label asp-for="Note" class="form-label">Nội dung/Ghi chú</label>
                <textarea asp-for="Note" class="form-control" rows="4"></textarea>
                <span asp-validation-for="Note" class="text-danger"></span>
            </div>

            <button type="submit" class="btn btn-primary">Tạo và Gửi thông báo</button>
        </form>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header">
        <h5 class="card-title mb-0">Danh sách thông báo đã tạo</h5>
    </div>
    <div class="card-body">
        @if (announcements != null && announcements.Any())
        {
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th>Khoa</th>
                            <th>Lớp</th>
                            <th>Năm học - Học kỳ</th>
                            <th>Ngày họp</th>
                            <th>Thời gian</th>
                            <th>Địa điểm</th>
                            <th>Ngày tạo</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in announcements)
                        {
                            <tr>
                                <td>@item.Faculty?.FacultyName</td>
                                <td>@item.Class?.ClassName</td>
                                <td>@item.AcademicYear?.YearName - @item.Semester?.SemesterName</td>
                                <td>@item.MeetingDate.ToString("dd/MM/yyyy")</td>
                                <td>@item.MeetingTime</td>
                                <td>@item.Location</td>
                                <td>@item.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>
                                    <a asp-action="Edit" asp-route-id="@item.MeetingId" class="btn btn-sm btn-outline-primary">Sửa</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <p>Chưa có thông báo nào được tạo.</p>
        }
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function () {
            function updateSelectWithOptions(selectElement, data, valueField, textField, defaultOptionText) {
                selectElement.empty();
                selectElement.append($('<option/>', { value: '', text: defaultOptionText }));
                $.each(data, function (index, item) {
                    selectElement.append($('<option/>', {
                        value: item[valueField],
                        text: item[textField]
                    }));
                });
            }

            $('#facultySelect').change(function () {
                var facultyId = $(this).val();
                var classSelect = $('#classSelect');
                if (facultyId) {
                    $.ajax({
                        url: '@Url.Action("GetClassesByFaculty", "ClassAnnouncement")',
                        type: 'GET',
                        data: { facultyId: facultyId },
                        success: function (data) {
                            updateSelectWithOptions(classSelect, data, 'classId', 'className', '-- Chọn Lớp --');
                        },
                        error: function () { alert('Lỗi khi tải danh sách lớp.'); }
                    });
                } else {
                    updateSelectWithOptions(classSelect, [], '', '', '-- Chọn Lớp --');
                }
            });

            $('#academicYearSelect').change(function () {
                var academicYearId = $(this).val();
                var semesterSelect = $('#semesterSelect');
                if (academicYearId) {
                    $.ajax({
                        url: '@Url.Action("GetSemestersByAcademicYear", "ClassAnnouncement")',
                        type: 'GET',
                        data: { academicYearId: academicYearId },
                        success: function (data) {
                            updateSelectWithOptions(semesterSelect, data, 'semesterId', 'semesterName', '-- Chọn Học kỳ --');
                        },
                        error: function () { alert('Lỗi khi tải danh sách học kỳ.'); }
                    });
                } else {
                     updateSelectWithOptions(semesterSelect, [], '', '', '-- Chọn Học kỳ --');
                }
            });
        
            if ($('#facultySelect').val()) {
                $('#facultySelect').trigger('change');
            }
            if ($('#academicYearSelect').val()) {
                $('#academicYearSelect').trigger('change');
            }
        });
    </script>
}