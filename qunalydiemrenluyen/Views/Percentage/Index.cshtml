@{
    ViewBag.Title = "Tỉ lệ % phiếu sinh viên đã gửi cho lớp trưởng";
    var total = (int)(ViewBag.Total ?? 0);
    var xuatSac = (int)(ViewBag.CountXuatSac ?? 0);
    var gioi = (int)(ViewBag.CountGioi ?? 0);
    var kha = (int)(ViewBag.CountKha ?? 0);
    var trungBinh = (int)(ViewBag.CountTrungBinh ?? 0);
    var yeu = (int)(ViewBag.CountYeu ?? 0);

    @* var selectedFacultyId = Context.Request.Query["facultyId"].ToString();
    var selectedClassId = Context.Request.Query["classId"].ToString(); *@
    var selectedAcademicYearId = Context.Request.Query["academicYearId"].ToString();
    var selectedSemesterId = Context.Request.Query["semesterId"].ToString();
}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>@ViewBag.Title</h2>
    <a href="@Url.Action("Index", "ClassEvaluate")" class="btn btn-secondary">Quay lại danh sách sinh viên</a>
</div>
<form method="get" class="row mb-3">
    @* <div class="col">
        <select name="facultyId" class="form-control" onchange="this.form.submit()">
            <option value="">-- Chọn khoa/viện --</option>
            @foreach (var f in ViewBag.Faculties)
            {
                <option value="@f.FacultyId" selected="@(selectedFacultyId == f.FacultyId.ToString() ? "selected" : null)">@f.FacultyName</option>
            }
        </select>
    </div>
    <div class="col">
        <select name="classId" class="form-control" onchange="this.form.submit()">
            <option value="">-- Chọn lớp --</option>
            @foreach (var c in ViewBag.Classes)
            {
                <option value="@c.ClassId" selected="@(selectedClassId == c.ClassId.ToString() ? "selected" : null)">@c.ClassName</option>
            }
        </select>
    </div> *@
    <div class="col">
        <select name="academicYearId" class="form-control" onchange="this.form.submit()">
            <option value="">-- Chọn năm học --</option>
            @foreach (var y in ViewBag.AcademicYears)
            {
                <option value="@y.AcademicYearId" selected="@(selectedAcademicYearId == y.AcademicYearId.ToString() ? "selected" : null)">@y.YearName</option>
            }
        </select>
    </div>
    <div class="col">
        <select name="semesterId" class="form-control" onchange="this.form.submit()">
            <option value="">-- Chọn học kỳ --</option>
            @foreach (var s in ViewBag.Semesters)
            {
                <option value="@s.SemesterId" selected="@(selectedSemesterId == s.SemesterId.ToString() ? "selected" : null)">@s.SemesterName</option>
            }
        </select>
    </div>
</form>

@if (total > 0)
{
    <div class="card">
        <div class="card-body">
            <canvas id="barChart" height="100"></canvas>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        var dataArr = [@xuatSac, @gioi, @kha, @trungBinh, @yeu];
        var total = dataArr.reduce((a, b) => a + b, 0);
        var labels = ['Xuất sắc', 'Giỏi', 'Khá', 'Trung bình', 'Yếu'];
        var colors = ['#4caf50', '#2196f3', '#ffc107', '#ff9800', '#f44336'];

        var ctx = document.getElementById('barChart').getContext('2d');
        var chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Số lượng',
                    data: dataArr,
                    backgroundColor: colors
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                var value = context.parsed.y;
                                var percent = total > 0 ? (value * 100 / total).toFixed(1) : 0;
                                return value + ' (' + percent + '%)';
                            }
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true, stepSize: 1 }
                }
            }
        });
    </script>
    <div class="mt-3">
        <b>Tổng số phiếu: @total</b>
        <ul>
            <li>Xuất sắc: @xuatSac (@(total > 0 ? (xuatSac * 100 / total).ToString("0.0") : "0")%)</li>
            <li>Giỏi: @gioi (@(total > 0 ? (gioi * 100 / total).ToString("0.0") : "0")%)</li>
            <li>Khá: @kha (@(total > 0 ? (kha * 100 / total).ToString("0.0") : "0")%)</li>
            <li>Trung bình: @trungBinh (@(total > 0 ? (trungBinh * 100 / total).ToString("0.0") : "0")%)</li>
            <li>Yếu: @yeu (@(total > 0 ? (yeu * 100 / total).ToString("0.0") : "0")%)</li>
        </ul>
    </div>
}
else
{
    <div class="alert alert-warning">Chưa có dữ liệu đánh giá phù hợp bộ lọc.</div>
}